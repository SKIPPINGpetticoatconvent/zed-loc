name: 01 Sync Upstream Zed Releases

on:
  schedule:
    - cron: "0 */6 * * *" # 每 6 小时检测一次
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 即使只读也建议写上

    steps:
      - name: 检查上游最新版本
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }} # 使用自带 Token 防止 API 速率限制
        run: |
          # 使用 gh cli 获取 tag_name，比 curl 更稳
          latest=$(gh api repos/zed-industries/zed/releases/latest --jq .tag_name)
          echo "检测到上游版本: $latest"
          echo "latest=$latest" >> $GITHUB_OUTPUT

      - name: 检查本地最新版本
        id: local
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 容错处理：如果本地还没发过版，设为 0.0.0
          local=$(gh api repos/${{ github.repository }}/releases/latest --jq .tag_name || echo "v0.0.0")
          echo "本地最新版本: $local"
          echo "local=$local" >> $GITHUB_OUTPUT

      - name: 触发汉化构建
        # 只有当版本不同，且上游版本不为空时才触发
        if: ${{ steps.upstream.outputs.latest != steps.local.outputs.local && steps.upstream.outputs.latest != '' }}
        uses: peter-evans/repository-dispatch@v3
        with:
          # ⚠️⚠️⚠️ 关键点：必须使用 PAT，否则无法唤醒 workflow 02
          token: ${{ secrets.SCOOP_PAT }}
          event-type: upstream-release
          client-payload: |
            {
              "version": "${{ steps.upstream.outputs.latest }}"
            }

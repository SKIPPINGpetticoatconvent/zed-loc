name: 02 æ›´æ–° Scoop Manifest

on:
  # 1. âœ… æ–°å¢ï¼šç›‘å¬ 01 å·è„šæœ¬æ˜¯å¦è¿è¡Œå®Œæˆ
  workflow_run:
    workflows: ["01 æ±‰åŒ–å‘è¡Œï¼ˆæ™ºèƒ½ç›‘æµ‹ï½œå…¨è‡ªåŠ¨æ„å»ºï¼‰"]
    types:
      - completed

  # 2. ä¿ç•™ï¼šæ‰‹åŠ¨å‘å¸ƒçš„äº‹ä»¶
  release:
    types: [published]

  # 3. ä¿ç•™ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Release ç‰ˆæœ¬å· (ç©ºåˆ™å–æœ€æ–°)"
        required: false
        type: string

jobs:
  update-bucket:
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'release' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      # 1. æ™ºèƒ½ç¡®å®šç‰ˆæœ¬å·
      - name: ç¡®å®šç›®æ ‡ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $manualTag = "${{ inputs.version_tag }}"
          $releaseEventTag = "${{ github.event.release.tag_name }}"
          $targetTag = ""

          if (-not [string]::IsNullOrWhiteSpace($manualTag)) {
             Write-Host "ğŸ‘‹ è§¦å‘æ¨¡å¼: æ‰‹åŠ¨è¾“å…¥"
             $targetTag = $manualTag
          } elseif (-not [string]::IsNullOrWhiteSpace($releaseEventTag)) {
             Write-Host "ğŸš€ è§¦å‘æ¨¡å¼: Release äº‹ä»¶"
             $targetTag = $releaseEventTag
          } else {
             Write-Host "ğŸ”„ è§¦å‘æ¨¡å¼: è‡ªåŠ¨è”åŠ¨"
             try {
                $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" -Method Get
                $targetTag = $latest.tag_name
             } catch {
                Write-Error "âŒ æ— æ³•è·å–æœ€æ–° Release ä¿¡æ¯"
                exit 1
             }
          }

          if ([string]::IsNullOrWhiteSpace($targetTag)) {
             Write-Error "âŒ æœªèƒ½ç¡®å®šç‰ˆæœ¬å·"
             exit 1
          }

          Write-Host "âœ… é”å®šç›®æ ‡ç‰ˆæœ¬: $targetTag"
          echo "TARGET_TAG=$targetTag" >> $env:GITHUB_ENV

      # 2. è·å–äº§ç‰©é“¾æ¥
      - name: ç­‰å¾…å¹¶è·å– Windows äº§ç‰©ä¿¡æ¯
        id: get_asset
        run: |
          $tag = $env:TARGET_TAG
          Write-Host "ğŸ” æ­£åœ¨æŸ¥æ‰¾ç‰ˆæœ¬: $tag"
          $maxRetries = 20
          $retryCount = 0
          $found = $false
          $targetNamePattern = "*windows*.zip"
          $apiUrl = "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag"

          while (-not $found -and $retryCount -lt $maxRetries) {
            try {
              $releaseData = Invoke-RestMethod -Uri $apiUrl -Method Get
              $winAsset = $releaseData.assets | Where-Object { $_.name -like $targetNamePattern } | Select-Object -First 1
              if ($null -ne $winAsset) {
                $found = $true
                Write-Host "âœ… æˆåŠŸæ‰¾åˆ°äº§ç‰©: $($winAsset.name)"
                echo "URL=$($winAsset.browser_download_url)" >> $env:GITHUB_ENV
                echo "FILENAME=$($winAsset.name)" >> $env:GITHUB_ENV
              } else { throw "Assets list is empty" }
            } catch {
              $retryCount++
              Write-Host "â³ ç­‰å¾…äº§ç‰©ä¸Šä¼ ... [$retryCount / $maxRetries]"
              Start-Sleep -Seconds 15
            }
          }
          if (-not $found) { Write-Error "âŒ æœªæ‰¾åˆ°äº§ç‰©"; exit 1 }

      # 3. ä¸‹è½½å¹¶è®¡ç®— Hash
      - name: ä¸‹è½½å¹¶è®¡ç®— Hash
        run: |
          Write-Host "â¬‡ï¸ ä¸‹è½½: $env:FILENAME"
          Invoke-WebRequest -Uri $env:URL -OutFile $env:FILENAME
          $hash = (Get-FileHash $env:FILENAME -Algorithm SHA256).Hash
          Write-Host "Hash: $hash"
          echo "SHA256=$hash" >> $env:GITHUB_ENV
          Remove-Item $env:FILENAME

      # 4. æ£€å‡º Bucket ä»“åº“
      - name: æ£€å‡º Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: SKIPPINGpetticoatconvent/zed-loc-scoop-bucket
          token: ${{ secrets.SCOOP_PAT }}
          path: bucket

      # 5. æ›´æ–°æˆ–åˆ›å»º Manifest (ä¿®å¤æŠ¥é”™çš„æ ¸å¿ƒéƒ¨åˆ†)
      - name: æ›´æ–°æˆ–åˆ›å»º Manifest
        run: |
          $manifestPath = "bucket/zed-loc.json"

          # --- å‡†å¤‡æ•°æ® ---
          $fixedShortcuts = @( ,@("zed.exe", "Zed") )

          $postInstall = @(
              "Write-Host 'Adding Context Menu items...'",
              '$zedPath = "$dir\zed.exe".Replace("\", "\\")',
              '$iconPath = "$dir\zed.exe,0".Replace("\", "\\")',
              'reg add "HKCU\Software\Classes\*\shell\Zed" /v "" /t REG_SZ /d "Open with Zed" /f',
              'reg add "HKCU\Software\Classes\*\shell\Zed" /v "Icon" /t REG_SZ /d "$iconPath" /f',
              'reg add "HKCU\Software\Classes\*\shell\Zed\command" /v "" /t REG_SZ /d "\"$zedPath\" \"%1\"" /f',
              "Write-Host 'Context Menu added.'"
          )

          $preUninstall = @(
              "Write-Host 'Removing Context Menu items...'",
              'reg delete "HKCU\Software\Classes\*\shell\Zed" /f',
              "Write-Host 'Context Menu removed.'"
          )

          $archObj = [PSCustomObject]@{
              "64bit" = @{
                  url = "$env:URL"
                  hash = "$env:SHA256"
              }
          }

          # --- é€»è¾‘å¼€å§‹ ---
          if (-not (Test-Path "$pwd\$manifestPath")) {
            Write-Host "âš ï¸ åˆå§‹åŒ–æ–° Manifest..."
            $json = [PSCustomObject]@{
                version = "$env:TARGET_TAG"
                description = "Zed Editor (Localized)"
                homepage = "https://github.com/SKIPPINGpetticoatconvent/zed-loc"
                license = "GPL-3.0-only"
                bin = "zed.exe"
                checkver = @{ github = "https://github.com/SKIPPINGpetticoatconvent/zed-loc" }
                autoupdate = @{ architecture = @{ "64bit" = @{ url = "https://github.com/SKIPPINGpetticoatconvent/zed-loc/releases/download/`$version/zed-windows.zip" } } }
            }
            # æ–°å»ºå¯¹è±¡ç›´æ¥æ·»åŠ å±æ€§
            $json | Add-Member -MemberType NoteProperty -Name "architecture" -Value $archObj
            $json | Add-Member -MemberType NoteProperty -Name "shortcuts" -Value $fixedShortcuts
            $json | Add-Member -MemberType NoteProperty -Name "post_install" -Value $postInstall
            $json | Add-Member -MemberType NoteProperty -Name "pre_uninstall" -Value $preUninstall

          } else {
            Write-Host "âœ… æ›´æ–°ç°æœ‰ Manifest..."
            $jsonContent = Get-Content "$pwd\$manifestPath" -Raw -Encoding UTF8
            $json = $jsonContent | ConvertFrom-Json

            # ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç»Ÿä¸€ä½¿ç”¨ Add-Member -Force
            # ä½œç”¨ï¼šå¦‚æœå±æ€§å­˜åœ¨åˆ™è¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºã€‚è§£å†³ "Property cannot be found" é”™è¯¯ã€‚

            # 1. æ›´æ–°ç‰ˆæœ¬
            $json.version = "$env:TARGET_TAG"

            # 2. æ›´æ–°æ¶æ„ (Force è¦†ç›–)
            $json | Add-Member -MemberType NoteProperty -Name "architecture" -Value $archObj -Force

            # 3. æ›´æ–°å¿«æ·æ–¹å¼ (Force è¦†ç›–)
            $json | Add-Member -MemberType NoteProperty -Name "shortcuts" -Value $fixedShortcuts -Force

            # 4. æ›´æ–°æ³¨å†Œè¡¨è„šæœ¬ (Force è¦†ç›–)
            $json | Add-Member -MemberType NoteProperty -Name "post_install" -Value $postInstall -Force
            $json | Add-Member -MemberType NoteProperty -Name "pre_uninstall" -Value $preUninstall -Force
          }

          # --- ä¿å­˜ ---
          $newContent = $json | ConvertTo-Json -Depth 10
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText("$pwd\$manifestPath", $newContent, $utf8NoBom)
          Write-Host "âœ… Manifest å·²ä¿®å¤å¹¶æ›´æ–°ã€‚"

      # 6. æ¨é€
      - name: æäº¤å¹¶æ¨é€
        run: |
          cd bucket
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if (git status --porcelain) {
            git add .
            git commit -m "Auto-update: zed-loc to $env:TARGET_TAG"
            git push
            Write-Host "ğŸš€ æ¨é€æˆåŠŸï¼"
          } else {
            Write-Host "âš ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚"
          }

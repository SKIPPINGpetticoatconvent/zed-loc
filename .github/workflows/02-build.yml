name: 02 汉化发行（全流程自动化｜三平台并行构建｜缓存加速）

on:
  workflow_dispatch:
    inputs:
      release:
        description: "是否发行"
        type: boolean
      branch:
        type: string
        default: main
        description: "分支名"

  repository_dispatch:
    types: [upstream-release]

  schedule:
    - cron: "0 15 * * *"

jobs:
  ###############################################################################
  # 1. Linux 初始化（生成版本号）
  ###############################################################################
  build-all:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.v }}

    steps:
      - name: Checkout zed-loc
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - id: version
        name: 设置版本号
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "v=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "v=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          fi

  ###############################################################################
  # 2. Windows：翻译 + 生成 patched-zed-src.7z
  ###############################################################################
  build-windows-patch:
    runs-on: windows-latest
    needs: build-all

    steps:
      - name: 设置 CARGO_HOME
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path C:\cargo
          Add-Content -Path $env:GITHUB_ENV -Value "CARGO_HOME=C:\cargo"

      - name: pip 缓存
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-win

      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安装 Python 依赖
        run: pip install pyyaml

      - name: Checkout zed-loc
        uses: actions/checkout@v4

      - name: 克隆 Zed（短路径）
        run: git clone https://github.com/zed-industries/zed.git C:\z

      - name: 复制翻译脚本
        shell: pwsh
        run: |
          Copy-Item extract.py C:\z\
          Copy-Item delete.py C:\z\
          Copy-Item replace.py C:\z\
          Copy-Item del.yaml C:\z\
          Copy-Item zh.json C:\z\

      - name: 执行翻译
        run: |
          cd C:\z
          python extract.py
          python delete.py
          python replace.py

      - name: 安装 7zip
        run: choco install 7zip -y

      - name: 使用 7zip 压缩翻译后源码
        run: |
          7z a patched-zed-src.7z C:\z\*

      - name: 上传 patched-zed-src
        uses: actions/upload-artifact@v4
        with:
          name: patched-zed-src
          path: patched-zed-src.7z

  ###############################################################################
  # 3. Windows：正式构建（短路径＋缓存＋sccache）
  ###############################################################################
  build-windows-bin:
    runs-on: windows-latest
    needs: build-windows-patch

    steps:
      - name: 设置 CARGO_HOME
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path C:\cargo
          Add-Content -Path $env:GITHUB_ENV -Value "CARGO_HOME=C:\cargo"

      - name: 禁用 wasmtime（必须在 Rust 之前）
        shell: pwsh
        run: Add-Content -Path $env:GITHUB_ENV -Value "ZED_DISABLE_WASMTIME=1"

      - name: 下载 patched-zed-src（必须在缓存之前）
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src
          path: .

      - name: Cargo 缓存（基于 patched-zed-src.7z）
        uses: actions/cache@v3
        with:
          path: |
            C:\cargo\registry
            C:\cargo\git
            C:\z\target
          key: cargo-win-${{ hashFiles('patched-zed-src.7z') }}
          restore-keys: cargo-win-

      - name: 安装 sccache
        run: choco install sccache -y

      - name: 配置 sccache
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_ENV -Value "RUSTC_WRAPPER=sccache"
          Add-Content -Path $env:GITHUB_ENV -Value "CARGO_INCREMENTAL=0"
          Add-Content -Path $env:GITHUB_ENV -Value "RUSTFLAGS=-Ccodegen-units=16"

      - name: 启动 sccache
        run: sccache --start-server

      - name: 解压 patched-zed-src
        run: |
          Remove-Item -Recurse -Force C:\z -ErrorAction SilentlyContinue
          7z x patched-zed-src.7z -oC:\z

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 构建 Windows
        run: |
          cd C:\z
          cargo build --release --jobs 2
          mkdir C:\winpkg
          Copy-Item target\release\zed.exe C:\winpkg
          powershell Compress-Archive -Path C:\winpkg\* -DestinationPath zed-windows.zip

      - name: 上传 Windows 包
        uses: actions/upload-artifact@v4
        with:
          name: zed-windows
          path: zed-windows.zip

  ###############################################################################
  # 4. Linux：构建（gold linker + 缓存修复）
  ###############################################################################
  build-linux:
    runs-on: ubuntu-latest
    needs: build-windows-patch

    steps:
      - name: 下载 patched-zed-src
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src
          path: .

      - name: 安装 Linux 构建依赖
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential pkg-config python3 libasound2-dev \
            libx11-dev libx11-xcb-dev libxkbfile-dev libgtk-3-dev \
            libxcb-xinput-dev libwayland-dev libxkbcommon-dev \
            libxkbcommon-x11-dev libxcb1-dev libxcb-render0-dev \
            libxcb-shape0-dev libxcb-xfixes0-dev libxcb-xinerama0-dev \
            libxcb-randr0-dev libxcb-keysyms1-dev libxcb-util-dev \
            libgl1-mesa-dev libegl1-mesa-dev \
            libfreetype6-dev libfontconfig1-dev \
            libssl-dev libudev-dev libclang-dev clang cmake

      - name: 解压
        run: |
          mkdir zed
          7z x patched-zed-src.7z -ozed

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo 缓存（Linux）
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            zed/target
          key: cargo-linux-${{ hashFiles('zed/Cargo.lock') }}
          restore-keys: cargo-linux-

      - name: 使用 Gold 链接器（修复 rust-lld 崩溃）
        run: |
          sudo apt install -y binutils-gold
          # 1. 设置 Linker (保留在 RUSTFLAGS 中)
          echo "RUSTFLAGS=-C link-arg=-fuse-ld=gold -Clink-arg=-Wl,--no-threads" >> $GITHUB_ENV

          # 2. 设置 LTO (使用专用变量，避免影响构建脚本)
          echo "CARGO_PROFILE_RELEASE_LTO=thin" >> $GITHUB_ENV

      - name: 构建 Linux
        run: |
          cd zed
          cargo build --release --jobs 2
          cd ..
          mkdir linuxpkg
          cp zed/target/release/zed linuxpkg/
          tar -czvf zed-linux-x86_64.tar.gz linuxpkg

      - name: 构建 deb 包
        run: |
          mkdir -p debpkg/usr/bin
          cp zed/target/release/zed debpkg/usr/bin/zed
          dpkg-deb --build debpkg zed-linux-x86_64.deb

      - name: 上传 Linux 包
        uses: actions/upload-artifact@v4
        with:
          name: zed-linux
          path: |
            zed-linux-x86_64.tar.gz
            zed-linux-x86_64.deb

  ###############################################################################
  # 5. macOS：构建（明确 ARM64 架构）
  ###############################################################################
  build-macos:
    runs-on: macos-latest
    needs: build-windows-patch

    steps:
      - name: 下载 patched-zed-src
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src
          path: .

      - name: 安装 macOS 构建依赖
        run: |
          brew install pkg-config
          brew install p7zip
          brew install xquartz

      - name: 解压
        run: |
          mkdir zed
          7z x patched-zed-src.7z -ozed

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo 缓存（macOS）
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            zed/target
          key: cargo-macos-${{ hashFiles('zed/Cargo.lock') }}
          restore-keys: cargo-macos-

      - name: 编译 macOS ARM64
        run: |
          cd zed
          cargo build --release --jobs 2
          cd ..
          mkdir macpkg
          cp zed/target/release/zed macpkg/
          tar -czvf zed-macos-aarch64.tar.gz macpkg/

      - name: 上传 Mac 包
        uses: actions/upload-artifact@v4
        with:
          name: zed-macos
          path: zed-macos-aarch64.tar.gz

  ###############################################################################
  # 6. Release（等待所有平台）
  ###############################################################################
  release:
    runs-on: ubuntu-latest
    needs:
      - build-windows-bin
      - build-linux
      - build-macos

    steps:
      - name: 下载所有产物
        uses: actions/download-artifact@v4

      - name: 生成 sha256
        run: |
          sha256sum zed-windows/zed-windows.zip > sha256sums.txt
          sha256sum zed-linux/zed-linux-x86_64.tar.gz >> sha256sums.txt
          sha256sum zed-linux/zed-linux-x86_64.deb >> sha256sums.txt
          sha256sum zed-macos/zed-macos-aarch64.tar.gz >> sha256sums.txt

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.build-all.outputs.version }}
          tag_name: ${{ needs.build-all.outputs.version }}
          files: |
            zed-windows/zed-windows.zip
            zed-linux/zed-linux-x86_64.tar.gz
            zed-linux/zed-linux-x86_64.deb
            zed-macos/zed-macos-aarch64.tar.gz
            sha256sums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

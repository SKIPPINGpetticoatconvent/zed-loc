name: 02 汉化发行（全流程一键自动化｜支持交叉编译 Windows）

on:
  workflow_dispatch:
    inputs:
      release:
        description: "是否发行"
        type: boolean
      branch:
        type: string
        default: main
        description: "分支名"

  repository_dispatch:
    types: [upstream-release]

  schedule:
    - cron: "0 15 * * *"

jobs:
  ################################################################################
  # 1. 全局初始化（Linux）
  ################################################################################
  build-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout zed-loc
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: 设置版本号
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "UPSTREAM_VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
          else
            echo "UPSTREAM_VERSION=$(date +'%Y%m%d')" >> $GITHUB_ENV
          fi
          echo "版本号：$UPSTREAM_VERSION"

  ################################################################################
  # 2. Windows job（仅词条处理，不构建 Windows 版本）
  ################################################################################
  process-windows-strings:
    runs-on: windows-latest
    needs: build-all

    steps:
      - name: Checkout zed-loc
        uses: actions/checkout@v4

      - name: 克隆 Zed 源码
        run: git clone https://github.com/zed-industries/zed.git

      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安装 Python 依赖
        run: pip install pyyaml

      - name: 提取词条
        run: python extract.py

      - name: 删除多余词条
        run: python delete.py

      - name: 替换词条
        run: python replace.py

      - name: 安装 7zip（Windows）
        run: choco install 7zip -y

      - name: 使用 7zip 压缩 patched 源码
        run: 7z a patched-zed-src.7z zed

      - name: 上传 patched 源码
        uses: actions/upload-artifact@v4
        with:
          name: patched-zed-src
          path: patched-zed-src.7z

  ################################################################################
  # 3. Linux job（交叉编译 Windows + Linux 二进制 + deb）
  ################################################################################
  build-linux:
    runs-on: ubuntu-latest
    needs: process-windows-strings

    steps:
      - name: 下载 patched 源码
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src

      - name: 安装 p7zip（Linux）
        run: sudo apt install p7zip-full -y

      - name: 解压 patched 源码
        run: 7z x patched-zed-src.7z

      - name: 安装 Rust（含 Windows 交叉编译工具链）
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            x86_64-pc-windows-gnu

      - name: 构建 Windows 版本（交叉编译）
        run: |
          cd zed
          cargo build --release --target x86_64-pc-windows-gnu
          cd ..
          mkdir winbuild
          cp zed/target/x86_64-pc-windows-gnu/release/zed.exe winbuild/
          zip -r zed-windows.zip winbuild

      - name: 构建 Linux 版本
        run: |
          cd zed
          cargo build --release
          cd ..
          mkdir linux-x86_64
          cp zed/target/release/zed linux-x86_64/
          tar -czvf zed-linux-x86_64.tar.gz linux-x86_64

      - name: 构建 deb
        run: |
          mkdir -p debpkg/usr/bin
          cp linux-x86_64/zed debpkg/usr/bin/zed
          dpkg-deb --build debpkg zed-linux-x86_64.deb

      - name: 上传 Linux + Windows 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: linux-windows-builds
          path: |
            zed-windows.zip
            zed-linux-x86_64.tar.gz
            zed-linux-x86_64.deb

  ################################################################################
  # 4. macOS job
  ################################################################################
  build-macos:
    runs-on: macos-latest
    needs: process-windows-strings

    steps:
      - name: 下载 patched 源码
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src

      - name: 解压 patched 源码
        run: unzip patched-zed-src.zip -d .

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 构建 macOS 版本
        run: |
          cd zed
          cargo build --release
          cd ..
          mkdir macbuild
          cp zed/target/release/zed macbuild/
          tar -czvf zed-macos.tar.gz macbuild/

      - name: 上传 mac 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: zed-macos.tar.gz

  ################################################################################
  # 5. Release job
  ################################################################################
  release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-macos

    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4

      - name: 生成 sha256
        run: |
          sha256sum linux-windows-builds/zed-windows.zip > sha256sums.txt
          sha256sum linux-windows-builds/zed-linux-x86_64.tar.gz >> sha256sums.txt
          sha256sum linux-windows-builds/zed-linux-x86_64.deb >> sha256sums.txt
          sha256sum mac-build/zed-macos.tar.gz >> sha256sums.txt

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.build-all.outputs.UPSTREAM_VERSION }}
          tag_name: ${{ needs.build-all.outputs.UPSTREAM_VERSION }}
          files: |
            linux-windows-builds/zed-windows.zip
            linux-windows-builds/zed-linux-x86_64.tar.gz
            linux-windows-builds/zed-linux-x86_64.deb
            mac-build/zed-macos.tar.gz
            sha256sums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: 02 汉化发行（全流程一键自动化｜Windows 短路径构建）

on:
  workflow_dispatch:
    inputs:
      release:
        description: "是否发行"
        type: boolean
      branch:
        type: string
        default: main
        description: "分支名"

  repository_dispatch:
    types: [upstream-release]

  schedule:
    - cron: "0 15 * * *"

jobs:
  ################################################################################
  # 1. Linux 全局初始化
  ################################################################################
  build-all:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.v }}
    steps:
      - name: Checkout zed-loc
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - id: version
        name: 设置版本号
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "v=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "v=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          fi
          echo "版本号：${{ steps.version.outputs.v }}"

  ################################################################################
  # 2. Windows：词条处理 + Windows 编译（短路径 C:\z）
  ################################################################################
  build-windows:
    runs-on: windows-latest
    needs: build-all

    steps:
      - name: Checkout zed-loc
        uses: actions/checkout@v4

      - name: 克隆 Zed 源码到短路径 C:\z（避免路径过长）
        run: git clone https://github.com/zed-industries/zed.git C:\z

      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安装 Python 依赖
        run: pip install pyyaml

      - name: 将 zed-loc 词条脚本复制到 C:\z
        run: |
          Copy-Item -Recurse -Force extract.py C:\z\
          Copy-Item -Recurse -Force delete.py C:\z\
          Copy-Item -Recurse -Force replace.py C:\z\
          Copy-Item -Recurse -Force del.yaml C:\z\
          Copy-Item -Recurse -Force strings.json C:\z\

      - name: 执行 extract
        run: |
          cd C:\z
          python extract.py

      - name: 执行 delete
        run: |
          cd C:\z
          python delete.py

      - name: 执行 replace
        run: |
          cd C:\z
          python replace.py

      - name: 安装 Rust（MSVC）
        uses: dtolnay/rust-toolchain@stable

      - name: 编译 Windows 版本（MSVC）
        run: |
          cd C:\z
          cargo build --release

      - name: 打包 Windows 产物
        run: |
          mkdir winpkg
          Copy-Item C:\z\target\release\zed.exe winpkg\
          powershell Compress-Archive -Path winpkg/* -DestinationPath zed-windows.zip

      - name: 上传 Windows 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: zed-windows
          path: zed-windows.zip

  ################################################################################
  # 3. Linux：原生 Linux tar.gz + deb
  ################################################################################
  build-linux:
    runs-on: ubuntu-latest
    needs: build-windows

    steps:
      - name: 下载 patched 源码（已翻译）
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src

      - name: 安装 p7zip
        run: sudo apt install p7zip-full -y

      - name: 解压 patched 源码
        run: |
          7z x patched-zed-src.7z
          mv zed patched-zed # 以免冲突
          mv patched-zed zed

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 构建 Linux 版本（已翻译）
        run: |
          cd zed
          cargo build --release
          cd ..
          mkdir linuxpkg
          cp zed/target/release/zed linuxpkg/
          tar -czvf zed-linux-x86_64.tar.gz linuxpkg

      - name: 构建 deb 包（已翻译）
        run: |
          mkdir -p debpkg/usr/bin
          cp zed/target/release/zed debpkg/usr/bin/zed
          dpkg-deb --build debpkg zed-linux-x86_64.deb

      - name: 上传 Linux 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: zed-linux
          path: |
            zed-linux-x86_64.tar.gz
            zed-linux-x86_64.deb

  ################################################################################
  # 4. macOS：原生构建
  ################################################################################
  build-macos:
    runs-on: macos-latest
    needs: build-windows

    steps:
      - name: 下载 patched 源码（已翻译）
        uses: actions/download-artifact@v4
        with:
          name: patched-zed-src

      - name: 安装 7zip
        run: brew install p7zip

      - name: 解压 patched 源码
        run: |
          7z x patched-zed-src.7z
          mv zed patched-zed
          mv patched-zed zed

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 构建 macOS 版本（已翻译）
        run: |
          cd zed
          cargo build --release
          cd ..
          mkdir macpkg
          cp zed/target/release/zed macpkg/
          tar -czvf zed-macos.tar.gz macpkg/

      - name: 上传 macOS 构建产物
        uses: actions/upload-artifact@v4
        with:
          name: zed-macos
          path: zed-macos.tar.gz

  ################################################################################
  # 5. Release 汇总发布
  ################################################################################
  release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-linux
      - build-macos

    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4

      - name: 生成 sha256
        run: |
          sha256sum zed-windows/zed-windows.zip > sha256sums.txt
          sha256sum zed-linux/zed-linux-x86_64.tar.gz >> sha256sums.txt
          sha256sum zed-linux/zed-linux-x86_64.deb >> sha256sums.txt
          sha256sum zed-macos/zed-macos.tar.gz >> sha256sums.txt

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.build-all.outputs.version }}
          tag_name: ${{ needs.build-all.outputs.version }}
          files: |
            zed-windows/zed-windows.zip
            zed-linux/zed-linux-x86_64.tar.gz
            zed-linux/zed-linux-x86_64.deb
            zed-macos/zed-macos.tar.gz
            sha256sums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: 02 Ê±âÂåñÂèëË°åÔºàÊô∫ËÉΩÁõëÊµãÔΩúÂÖ®Ëá™Âä®ÊûÑÂª∫Ôºâ

on:
  # ‚úÖ ÂÖÅËÆ∏ Push Âà∞‰∏ªÂàÜÊîØÊó∂Ëß¶Âèë (Êñπ‰æøË∞ÉËØï/Ëá™Ê£Ä)
  push:
    branches:
      - main
    paths:
      - '.github/workflows/*.yml'

  # ‚úÖ ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      release:
        description: "ÊòØÂê¶Ê≠£ÂºèÂèëÂ∏É Release"
        type: boolean
        default: true
      version:
        description: "ÊåáÂÆöÊûÑÂª∫ÁâàÊú¨ (Á©∫ÂàôËá™Âä®Ëé∑ÂèñÂÆòÊñπÊúÄÊñ∞)"
        type: string

  # ‚úÖ ÂÆöÊó∂‰ªªÂä°ÔºöÊØè 6 Â∞èÊó∂Ëá™Ê£Ä‰∏ÄÊ¨°
  schedule:
    - cron: "0 */6 * * *"

# ‚úÖ Á°Æ‰øùÊúâÂàõÂª∫ Release ÁöÑÊùÉÈôê
permissions:
  contents: write

env:
  ZED_REPO: https://github.com/zed-industries/zed.git
  # === ‚ö°Ô∏è Âä†ÈÄüÈÖçÁΩÆ ===
  CARGO_PROFILE_RELEASE_CODEGEN_UNITS: "16"
  RUSTC_WRAPPER: "sccache"
  CARGO_INCREMENTAL: "0"
  SCCACHE_RECACHE_THIRD_PARTY_DEPS: "1"
  SCCACHE_CACHE_SIZE: "10G"
  SCCACHE_IDLE_TIMEOUT: "0"

jobs:
  # ===========================================================================
  # 1. Êô∫ËÉΩÁâàÊú¨Âà§Êñ≠
  # ===========================================================================
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_vars.outputs.v }}
      should_release: ${{ steps.set_vars.outputs.r }}
    steps:
      - id: set_vars
        run: |
          echo "Trigger Event: ${{ github.event_name }}"

          # === 1. ÊâãÂä®Ëß¶Âèë (workflow_dispatch) ===
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             INPUT_VER="${{ github.event.inputs.version }}"
             if [ -n "$INPUT_VER" ]; then
                echo "üëã ÊâãÂä®ÊåáÂÆöÁâàÊú¨: $INPUT_VER"
                echo "v=$INPUT_VER" >> $GITHUB_OUTPUT
             else
                # ÊâãÂä®Ëß¶Âèë‰ΩÜÊ≤°Â°´ÁâàÊú¨ÔºåÂéªÊü•‰∏Ä‰∏ãÊúÄÊñ∞
                LATEST=$(curl -s https://api.github.com/repos/zed-industries/zed/releases/latest | jq -r .tag_name)
                echo "üëã ÊâãÂä®Ëß¶ÂèëÔºåËá™Âä®Ëé∑ÂèñÊúÄÊñ∞: $LATEST"
                echo "v=$LATEST" >> $GITHUB_OUTPUT
             fi
             echo "r=${{ github.event.inputs.release }}" >> $GITHUB_OUTPUT

          # === 2. Ëá™Âä®Ëß¶Âèë (Schedule / Push) ===
          else
             echo "‚è∞ ÂÆöÊó∂‰ªªÂä°/Push Ëß¶ÂèëÔºåÊ≠£Âú®Ëá™Ê£Ä..."
             
             # Ëé∑ÂèñÂÆòÊñπÊúÄÊñ∞Áâà
             UPSTREAM=$(curl -s https://api.github.com/repos/zed-industries/zed/releases/latest | jq -r .tag_name)
             
             # Ëé∑ÂèñËá™Â∑±‰ªìÂ∫ìÊúÄÊñ∞Áâà (Â¶ÇÊûúÊ≤°Êúâ ReleaseÔºåÈªòËÆ§‰∏∫Á©∫)
             LOCAL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
             
             echo "üîç ÂÆòÊñπÊúÄÊñ∞: $UPSTREAM"
             echo "üîç Êú¨Âú∞ÊúÄÊñ∞: $LOCAL"

             if [ "$UPSTREAM" != "null" ] && [ "$UPSTREAM" != "$LOCAL" ]; then
                echo "üöÄ ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºÅÂáÜÂ§áÊûÑÂª∫: $UPSTREAM"
                echo "v=$UPSTREAM" >> $GITHUB_OUTPUT
                echo "r=true" >> $GITHUB_OUTPUT
             else
                echo "üí§ ÁâàÊú¨‰∏ÄËá¥ÊàñÊó†Êõ¥Êñ∞ÔºåË∑≥ËøáÊûÑÂª∫„ÄÇ"
                echo "r=false" >> $GITHUB_OUTPUT
             fi
          fi

  # ===========================================================================
  # 2. Windows ÊûÑÂª∫
  # ===========================================================================
  build-windows:
    needs: versioning
    if: ${{ needs.versioning.outputs.should_release == 'true' }}
    runs-on: windows-latest
    env:
      SCCACHE_DIR: C:\c\sccache
      SCCACHE_IDLE_TIMEOUT: "0"
      BUILD_VERSION: ${{ needs.versioning.outputs.version }}
    steps:
      - name: Ê£ÄÂá∫Ê±âÂåñ‰ªìÂ∫ì
        uses: actions/checkout@v4

      - name: ÂºÄÂêØ Git Longpaths
        run: git config --system core.longpaths true

      - name: ËÆæÁΩÆÁõÆÂΩïÁéØÂ¢É
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path C:\c
          New-Item -ItemType Directory -Force -Path C:\c\sccache
          echo "CARGO_HOME=C:\c" >> $env:GITHUB_ENV

      - name: ÂÖãÈöÜ Zed Ê∫êÁ†ÅÂπ∂Ê£ÄÂá∫ Tag
        shell: pwsh
        run: |
          git clone ${{ env.ZED_REPO }} C:\z
          Set-Location C:\z
          git checkout $env:BUILD_VERSION
          Write-Host "Â∑≤ÂàáÊç¢Âà∞ÁâàÊú¨: $env:BUILD_VERSION"

      - name: ÊâßË°åÊ±âÂåñÊõøÊç¢
        shell: pwsh
        run: |
          Copy-Item replace.py C:\
          Copy-Item zh.json C:\
          Set-Location C:\
          Rename-Item -Path "z" -NewName "zed"
          python replace.py
          Rename-Item -Path "zed" -NewName "z"

      - name: ÂáÜÂ§á Rust ÁéØÂ¢É
        run: |
          rustup update stable
          rustup default stable
      
      - name: ÂÆâË£Ö sccache
        run: choco install sccache -y

      - name: ÂêØÁî® sccache ÁºìÂ≠ò
        uses: actions/cache@v3
        with:
          path: |
            C:\c\sccache
            C:\c\registry
            C:\c\git
            C:\z\target
          key: sccache-win-${{ hashFiles('C:\z\Cargo.lock') }}
          restore-keys: sccache-win-

      - name: ÂêØÂä® sccache server
        run: |
          sccache --start-server
          sccache --zero-stats

      - name: ÊûÑÂª∫ Release (Â∏¶ÈáçËØï)
        shell: pwsh
        env:
          RUSTC_WRAPPER: sccache
        run: |
          cd C:\z
          $maxRetries = 3
          $retryCount = 0
          do {
              $retryCount++
              Write-Host "üöÄ Build Attempt $retryCount / $maxRetries"
              cargo build --release --jobs 2
              if ($LASTEXITCODE -eq 0) { Write-Host "‚úÖ Success!"; exit 0 }
              Write-Host "‚ö†Ô∏è Failed code $LASTEXITCODE."
              if ($retryCount -lt $maxRetries) { Start-Sleep -Seconds 15 }
          } while ($retryCount -lt $maxRetries)
          exit 1

      - name: ÂÅúÊ≠¢ sccache
        shell: pwsh
        run: |
          sccache --show-stats
          sccache --stop-server || true

      - name: ÊâìÂåÖ Windows
        shell: pwsh
        run: |
          mkdir zed-dist
          Copy-Item C:\z\target\release\zed.exe zed-dist\
          Compress-Archive -Path zed-dist\* -DestinationPath zed-windows.zip

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: zed-windows
          path: zed-windows.zip

  # ===========================================================================
  # 3. Linux ÊûÑÂª∫
  # ===========================================================================
  build-linux:
    needs: versioning
    if: ${{ needs.versioning.outputs.should_release == 'true' }}
    runs-on: ubuntu-latest
    env:
      SCCACHE_DIR: /home/runner/.cache/sccache
      SCCACHE_IDLE_TIMEOUT: "0"
      BUILD_VERSION: ${{ needs.versioning.outputs.version }}
    steps:
      - name: ÈáäÊîæÁ£ÅÁõòÁ©∫Èó¥
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: false

      - name: Ê£ÄÂá∫Ê±âÂåñ‰ªìÂ∫ì
        uses: actions/checkout@v4

      - name: ÂÆâË£Ö sccache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: ÂÆâË£Ö‰æùËµñ
        run: |
          sudo apt update
          sudo apt install -y build-essential pkg-config python3 libasound2-dev \
            libx11-dev libx11-xcb-dev libxkbfile-dev libgtk-3-dev \
            libxcb-xinput-dev libwayland-dev libxkbcommon-dev \
            libxkbcommon-x11-dev libxcb1-dev libxcb-render0-dev \
            libxcb-shape0-dev libxcb-xfixes0-dev libxcb-xinerama0-dev \
            libxcb-randr0-dev libxcb-keysyms1-dev libxcb-util-dev \
            libgl1-mesa-dev libegl1-mesa-dev libfreetype6-dev libfontconfig1-dev \
            libssl-dev libudev-dev libclang-dev clang cmake binutils-gold
          echo "RUSTFLAGS=-C link-arg=-fuse-ld=gold -Clink-arg=-Wl,--no-threads" >> $GITHUB_ENV

      - name: ÂÖãÈöÜ Zed Ê∫êÁ†ÅÂπ∂Ê£ÄÂá∫ Tag
        run: |
          git clone ${{ env.ZED_REPO }} zed
          cd zed
          git checkout $BUILD_VERSION
          echo "Checked out $BUILD_VERSION"

      - name: ÊâßË°åÊ±âÂåñÊõøÊç¢
        run: python3 replace.py

      - name: ÂêØÁî® sccache ÁºìÂ≠ò
        uses: actions/cache@v3
        with:
          path: |
            /home/runner/.cache/sccache
            ~/.cargo/registry
            ~/.cargo/git
          key: sccache-linux-${{ hashFiles('zed/Cargo.lock') }}
          restore-keys: sccache-linux-

      - name: ÂÆâË£Ö Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ÂêØÂä® sccache
        run: |
          sccache --stop-server || true
          sccache --start-server
          sccache --zero-stats
          sccache -s

      - name: ÊûÑÂª∫ Release
        env:
          RUSTC_WRAPPER: sccache
        run: |
          cd zed
          cargo build --release --jobs 2

      - name: ÂÅúÊ≠¢ sccache
        run: |
          sccache --show-stats
          sccache --stop-server || true

      - name: ÊâìÂåÖ Linux
        run: |
          mkdir -p dist/usr/bin
          cp zed/target/release/zed dist/usr/bin/
          tar -czvf zed-linux-x86_64.tar.gz -C dist .

          mkdir -p deb-pkg/DEBIAN deb-pkg/usr/bin
          cp zed/target/release/zed deb-pkg/usr/bin/
          RAW_VERSION="${{ needs.versioning.outputs.version }}"
          CLEAN_VERSION="${RAW_VERSION#v}"
          echo "Package: zed-editor" > deb-pkg/DEBIAN/control
          echo "Version: $CLEAN_VERSION" >> deb-pkg/DEBIAN/control
          echo "Architecture: amd64" >> deb-pkg/DEBIAN/control
          echo "Maintainer: Zed-Loc" >> deb-pkg/DEBIAN/control
          echo "Description: A high-performance, multiplayer code editor." >> deb-pkg/DEBIAN/control
          dpkg-deb --build deb-pkg zed-linux-x86_64.deb

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: zed-linux
          path: |
            zed-linux-x86_64.tar.gz
            zed-linux-x86_64.deb

  # ===========================================================================
  # 4. macOS ÊûÑÂª∫ (Â∑≤‰øÆÂ§ç hdiutil busy ÈîôËØØ)
  # ===========================================================================
  build-macos:
    needs: versioning
    if: ${{ needs.versioning.outputs.should_release == 'true' }}
    runs-on: macos-latest
    env:
      SCCACHE_DIR: /Users/runner/Library/Caches/Mozilla.sccache
      SCCACHE_IDLE_TIMEOUT: "0"
      BUILD_VERSION: ${{ needs.versioning.outputs.version }}
    steps:
      - name: Ê£ÄÂá∫Ê±âÂåñ‰ªìÂ∫ì
        uses: actions/checkout@v4

      - name: ÂÆâË£Ö sccache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: ÂÖãÈöÜ Zed Ê∫êÁ†ÅÂπ∂Ê£ÄÂá∫ Tag
        run: |
          git clone ${{ env.ZED_REPO }} zed
          cd zed
          git checkout $BUILD_VERSION

      - name: ÊâßË°åÊ±âÂåñÊõøÊç¢
        run: python3 replace.py

      - name: ÂêØÁî® sccache ÁºìÂ≠ò
        uses: actions/cache@v3
        with:
          path: |
            /Users/runner/Library/Caches/Mozilla.sccache
            ~/.cargo/registry
            ~/.cargo/git
          key: sccache-macos-${{ hashFiles('zed/Cargo.lock') }}
          restore-keys: sccache-macos-

      - name: ÂÆâË£Ö Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: ÂêØÂä® sccache
        run: |
          sccache --start-server
          sccache --zero-stats

      - name: ÊûÑÂª∫ macOS Release
        env:
          RUSTC_WRAPPER: sccache
        run: |
          cd zed
          cargo build --release --target aarch64-apple-darwin --jobs 4

          APP_NAME="Zed.app"
          mkdir -p "$APP_NAME/Contents/MacOS" "$APP_NAME/Contents/Resources"
          cp target/aarch64-apple-darwin/release/zed "$APP_NAME/Contents/MacOS/zed"

          cat > "$APP_NAME/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>zed</string>
              <key>CFBundleIdentifier</key>
              <string>dev.zed.Zed</string>
              <key>CFBundleName</key>
              <string>Zed</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ needs.versioning.outputs.version }}</string>
          </dict>
          </plist>
          EOF
          
          # === ‰øÆÂ§ç: Á≠âÂæÖÊñá‰ª∂Á≥ªÁªüÂπ∂ÈáçËØï hdiutil ===
          echo "üí§ ÁºñËØëÂÆåÊàêÔºåÁ≠âÂæÖÊñá‰ª∂Á≥ªÁªüÁ®≥ÂÆö (10s)..."
          sleep 10
          
          echo "üì¶ ÂºÄÂßãÊâìÂåÖ DMG..."
          n=0
          until [ "$n" -ge 10 ]
          do
             hdiutil create -volname Zed -srcfolder "$APP_NAME" -ov -format UDZO zed-macos-aarch64.dmg && break
             n=$((n+1))
             echo "‚ö†Ô∏è hdiutil Â§±Ë¥• (Resource busy?), Á≠âÂæÖ 15ÁßíÂêéÈáçËØï ($n/10)..."
             sleep 15
          done
          
          if [ ! -f "zed-macos-aarch64.dmg" ]; then
             echo "‚ùå ÊúÄÁªàÊâìÂåÖÂ§±Ë¥•ÔºåÈÄÄÂá∫„ÄÇ"
             exit 1
          fi

          mv zed-macos-aarch64.dmg ../

      - name: ÂÅúÊ≠¢ sccache
        run: |
          sccache --show-stats
          sccache --stop-server || true

      - name: ‰∏ä‰º†‰∫ßÁâ©
        uses: actions/upload-artifact@v4
        with:
          name: zed-macos
          path: zed-macos-aarch64.dmg

  # ===========================================================================
  # 5. Ê≠£ÂºèÂèëÂ∏É
  # ===========================================================================
  release:
    runs-on: ubuntu-latest
    needs: [versioning, build-windows, build-linux, build-macos]
    if: ${{ needs.versioning.outputs.should_release == 'true' }}

    steps:
      - name: ‰∏ãËΩΩÊâÄÊúâ‰∫ßÁâ©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Êï¥ÁêÜÊñá‰ª∂‰∏éÁîüÊàê Hash
        run: |
          mkdir release-dist
          # Â¶ÇÊûúÊüê‰∏™Âπ≥Âè∞ÊûÑÂª∫Â§±Ë¥•ÊàñË∑≥ËøáÔºåmv ÂèØËÉΩ‰ºöÊä•ÈîôÔºåÊâÄ‰ª•Âä†‰∏™ || true ÊàñËÄÖÊ£ÄÊü•Êñá‰ª∂Â≠òÂú®
          mv artifacts/zed-windows/zed-windows.zip release-dist/ || echo "No Windows artifact"
          mv artifacts/zed-linux/zed-linux-x86_64.tar.gz release-dist/ || echo "No Linux tar artifact"
          mv artifacts/zed-linux/zed-linux-x86_64.deb release-dist/ || echo "No Linux deb artifact"
          mv artifacts/zed-macos/zed-macos-aarch64.dmg release-dist/ || echo "No macOS artifact"

          cd release-dist
          sha256sum * > sha256sums.txt

      - name: ÂèëÂ∏É Release
        uses: softprops/action-gh-release@v2
        with:
          name: Zed Ê±âÂåñÁâà ${{ needs.versioning.outputs.version }}
          tag_name: ${{ needs.versioning.outputs.version }}
          files: release-dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

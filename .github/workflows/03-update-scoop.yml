name: 03 Update Scoop Manifest

on:
  release:
    types: [published]

jobs:
  update-bucket:
    runs-on: windows-latest
    steps:
      - name: 获取 Windows 产物信息
        id: get_asset
        run: |
          # === 关键修复 1: 精准查找 Windows zip 包 ===
          # 遍历 JSON 寻找 name 结尾是 .zip 的文件
          $assets = '${{ toJson(github.event.release.assets) }}' | ConvertFrom-Json
          $winAsset = $assets | Where-Object { $_.name -like "*.zip" } | Select-Object -First 1

          if ($null -eq $winAsset) {
            Write-Error "❌ 未找到 .zip 格式的 Windows 产物，请检查 Release 文件。"
            exit 1
          }

          echo "URL=$($winAsset.browser_download_url)" >> $env:GITHUB_ENV
          echo "FILENAME=$($winAsset.name)" >> $env:GITHUB_ENV

      - name: 下载并计算 Hash
        run: |
          Write-Host "正在下载: $env:FILENAME"
          Invoke-WebRequest -Uri $env:URL -OutFile $env:FILENAME
          
          $hash = (Get-FileHash $env:FILENAME -Algorithm SHA256).Hash
          echo "SHA256=$hash" >> $env:GITHUB_ENV
          
          # 清理下载的文件
          Remove-Item $env:FILENAME

      - name: 检出 Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: SKIPPINGpetticoatconvent/zed-loc-scoop-bucket
          # === 关键修复 2: 使用 PAT 替代默认 Token ===
          # 你需要在仓库 Secrets 里存入一个名为 SCOOP_PAT 的 Token
          token: ${{ secrets.SCOOP_PAT }} 
          path: bucket

      - name: 更新 manifest
        run: |
          $manifestPath = "bucket/zed-loc.json"
          
          # 读取并解析 JSON
          $json = Get-Content $manifestPath -Raw | ConvertFrom-Json
          
          # 更新字段
          $json.version = "${{ github.event.release.tag_name }}"
          $json.url = "$env:URL"
          $json.hash = "$env:SHA256"
          
          # === 关键修复 3: 强制 UTF-8 无 BOM 格式写入 ===
          # PowerShell 5.1 默认会有 BOM，Scoop 有时不喜欢 BOM
          $newContent = $json | ConvertTo-Json -Depth 10
          [System.IO.File]::WriteAllText("$pwd\$manifestPath", $newContent)

      - name: 提交并推送
        run: |
          cd bucket
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 检查是否有变更（防止重复运行报错）
          if (git status --porcelain) {
            git add .
            git commit -m "Auto-update: zed-loc to ${{ github.event.release.tag_name }}"
            git push
            Write-Host "✅ Scoop Manifest 已更新"
          } else {
            Write-Host "⚠️ 内容无变化，跳过提交"
          }

name: 03 Update Scoop Manifest

on:
  release:
    types: [published]
  
  # === æ”¯æŒæ‰‹åŠ¨è§¦å‘ (æ–¹ä¾¿è°ƒè¯•æˆ–ä¿®å¤) ===
  workflow_dispatch:
    inputs:
      version_tag:
        description: "Release ç‰ˆæœ¬å· (ä¾‹å¦‚: v20251125)"
        required: true
        type: string

jobs:
  update-bucket:
    runs-on: windows-latest
    steps:
      # 1. ç¡®å®šç‰ˆæœ¬å· (è‡ªåŠ¨ vs æ‰‹åŠ¨)
      - name: ç¡®å®šç›®æ ‡ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          $autoTag = "${{ github.event.release.tag_name }}"
          $manualTag = "${{ inputs.version_tag }}"

          if (-not [string]::IsNullOrWhiteSpace($autoTag)) {
            echo "TARGET_TAG=$autoTag" >> $env:GITHUB_ENV
            Write-Host "ğŸš€ è§¦å‘æ¨¡å¼: è‡ªåŠ¨ Release ($autoTag)"
          } elseif (-not [string]::IsNullOrWhiteSpace($manualTag)) {
            echo "TARGET_TAG=$manualTag" >> $env:GITHUB_ENV
            Write-Host "ğŸ‘‹ è§¦å‘æ¨¡å¼: æ‰‹åŠ¨è¾“å…¥ ($manualTag)"
          } else {
            Write-Error "âŒ æ— æ³•ç¡®å®šç‰ˆæœ¬å·ï¼"
            exit 1
          }

      # 2. è·å–äº§ç‰©é“¾æ¥ (å¸¦é‡è¯•æœºåˆ¶)
      - name: ç­‰å¾…å¹¶è·å– Windows äº§ç‰©ä¿¡æ¯
        id: get_asset
        run: |
          $tag = $env:TARGET_TAG
          Write-Host "ğŸ” æ­£åœ¨æŸ¥æ‰¾ç‰ˆæœ¬: $tag"
          
          $maxRetries = 20
          $retryCount = 0
          $found = $false
          $targetNamePattern = "*windows*.zip"
          $apiUrl = "https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag"
          
          while (-not $found -and $retryCount -lt $maxRetries) {
            try {
              $releaseData = Invoke-RestMethod -Uri $apiUrl -Method Get
              $winAsset = $releaseData.assets | Where-Object { $_.name -like $targetNamePattern } | Select-Object -First 1

              if ($null -ne $winAsset) {
                $found = $true
                Write-Host "âœ… æˆåŠŸæ‰¾åˆ°äº§ç‰©: $($winAsset.name)"
                echo "URL=$($winAsset.browser_download_url)" >> $env:GITHUB_ENV
                echo "FILENAME=$($winAsset.name)" >> $env:GITHUB_ENV
              } else {
                throw "Assets list is empty"
              }
            } catch {
              $retryCount++
              Write-Host "â³ [$retryCount / $maxRetries] äº§ç‰©å¯èƒ½è¿˜åœ¨ä¸Šä¼ ä¸­ï¼Œç­‰å¾… 15 ç§’..."
              Start-Sleep -Seconds 15
            }
          }

          if (-not $found) {
            Write-Error "âŒ å¤±è´¥ï¼šåœ¨ Release ($tag) ä¸­æœªæ‰¾åˆ°ç¬¦åˆ '$targetNamePattern' çš„æ–‡ä»¶ã€‚"
            exit 1
          }

      # 3. ä¸‹è½½å¹¶è®¡ç®— Hash
      - name: ä¸‹è½½å¹¶è®¡ç®— Hash
        run: |
          Write-Host "â¬‡ï¸ æ­£åœ¨ä¸‹è½½: $env:FILENAME"
          Invoke-WebRequest -Uri $env:URL -OutFile $env:FILENAME
          $hash = (Get-FileHash $env:FILENAME -Algorithm SHA256).Hash
          Write-Host "Hash: $hash"
          echo "SHA256=$hash" >> $env:GITHUB_ENV
          Remove-Item $env:FILENAME

      # 4. æ£€å‡º Bucket ä»“åº“
      - name: æ£€å‡º Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: SKIPPINGpetticoatconvent/zed-loc-scoop-bucket
          token: ${{ secrets.SCOOP_PAT }} 
          path: bucket

      # 5. æ›´æ–°æˆ–åˆ›å»º JSON (æ ¸å¿ƒé€»è¾‘)
      - name: æ›´æ–°æˆ–åˆ›å»º Manifest
        run: |
          # è®¾å®šæ–‡ä»¶è·¯å¾„ (åœ¨æ£€å‡ºçš„ bucket æ–‡ä»¶å¤¹å†…)
          $manifestPath = "bucket/zed-loc.json"
          
          # === åˆ†æ”¯ A: æ–‡ä»¶ä¸å­˜åœ¨ -> åˆå§‹åŒ–æ–°æ–‡ä»¶ ===
          if (-not (Test-Path "$pwd\$manifestPath")) {
            Write-Host "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆå§‹åŒ–æ–°çš„ Manifest..."
            
            # åˆ›å»ºåˆå§‹ JSON ç»“æ„
            $json = [PSCustomObject]@{
                version = "$env:TARGET_TAG"
                description = "Zed Editor (Localized)"
                homepage = "https://github.com/SKIPPINGpetticoatconvent/zed-loc"
                license = "GPL-3.0-only"
                architecture = @{
                    "64bit" = @{
                        url = "$env:URL"
                        hash = "$env:SHA256"
                    }
                }
                bin = "zed.exe"
                shortcuts = @(
                    @("zed.exe", "Zed")
                )
                checkver = @{
                    github = "https://github.com/SKIPPINGpetticoatconvent/zed-loc"
                }
                autoupdate = @{
                    architecture = @{
                        "64bit" = @{
                            url = "https://github.com/SKIPPINGpetticoatconvent/zed-loc/releases/download/`$version/zed-windows.zip"
                        }
                    }
                }
            }
          } 
          # === åˆ†æ”¯ B: æ–‡ä»¶å­˜åœ¨ -> æ›´æ–°ç°æœ‰æ–‡ä»¶ ===
          else {
            Write-Host "âœ… å‘ç°ç°æœ‰ Manifestï¼Œæ­£åœ¨è¯»å–..."
            $jsonContent = Get-Content "$pwd\$manifestPath" -Raw -Encoding UTF8
            $json = $jsonContent | ConvertFrom-Json
            
            # æ›´æ–°ç‰ˆæœ¬
            $json.version = "$env:TARGET_TAG"
            
            # æ™ºèƒ½æ›´æ–° URL å’Œ Hash
            if ($json.PSObject.Properties.Match('architecture') -and $json.architecture.PSObject.Properties.Match('64bit')) {
                $json.architecture.'64bit'.url = "$env:URL"
                $json.architecture.'64bit'.hash = "$env:SHA256"
            } else {
                $json.url = "$env:URL"
                $json.hash = "$env:SHA256"
            }
          }
          
          # === ç»Ÿä¸€å†™å…¥ (å¼ºåˆ¶ UTF-8 æ—  BOM) ===
          $newContent = $json | ConvertTo-Json -Depth 10
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText("$pwd\$manifestPath", $newContent, $utf8NoBom)
          
          Write-Host "âœ… Manifest å·²æˆåŠŸå†™å…¥: $manifestPath"

      # 6. æ¨é€æ›´æ”¹
      - name: æäº¤å¹¶æ¨é€
        run: |
          cd bucket
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          if (git status --porcelain) {
            git add .
            git commit -m "Auto-update: zed-loc to $env:TARGET_TAG"
            git push
            Write-Host "ğŸš€ æ¨é€æˆåŠŸï¼"
          } else {
            Write-Host "âš ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æ¨é€ã€‚"
          }

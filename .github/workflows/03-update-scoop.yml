name: 03 Update Scoop Manifest

on:
  release:
    types: [published]

jobs:
  update:
    runs-on: windows-latest

    steps:
      - name: 下载 Windows 构建产物
        run: |
          $url = "${{ github.event.release.assets[0].browser_download_url }}"
          Invoke-WebRequest -Uri $url -OutFile zed-windows.zip

      - name: 生成 SHA256
        run: |
          $sha = (Get-FileHash zed-windows.zip -Algorithm SHA256).Hash
          echo "SHA256=$sha" >> $env:GITHUB_ENV

      - name: 克隆 Scoop bucket
        uses: actions/checkout@v4
        with:
          repository: SKIPPINGpetticoatconvent/scoop-bucket
          token: ${{ secrets.GITHUB_TOKEN }}
          path: bucket

      - name: 更新 zed-loc.json
        run: |
          $file = "bucket/zed-loc.json"
          $json = Get-Content $file | ConvertFrom-Json
          $json.version = "${{ github.event.release.tag_name }}"
          $json.url = "${{ github.event.release.assets[0].browser_download_url }}"
          $json.hash = "${{ env.SHA256 }}"
          $json | ConvertTo-Json -Depth 10 | Out-File $file -Encoding UTF8

      - name: 推送到 scoop bucket
        run: |
          cd bucket
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add zed-loc.json
          git commit -m "update to ${{ github.event.release.tag_name }}"
          git push
